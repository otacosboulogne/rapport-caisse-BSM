<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rapport RH et Caisse Boulogne-sur-Mer</title>
  <style>
    :root{
      --bg:#fff7ed;
      --card:#ffffff;
      --accent:#f97316;
      --accent-soft:#ffedd5;
      --accent-strong:#c2410c;
      --danger:#dc2626;
      --danger-soft:#fee2e2;
      --ok:#16a34a;
      --ok-soft:#dcfce7;
      --muted:#4b5563;
      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(124, 45, 18, 0.25);
      --radius-lg:14px;
      --radius-md:10px;
      --radius-sm:8px;
      --transition-fast:150ms ease-out;
    }

    *{box-sizing:border-box}

    body{
      font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background:radial-gradient(circle at top, #fed7aa 0, #ffedd5 40%, #fff7ed 100%);
      margin:0;
      padding:32px 16px;
      color:#111827;
    }

    .container{
      max-width:960px;
      margin:0 auto;
    }

    header{
      display:flex;
      align-items:flex-start;
      gap:16px;
      margin-bottom:20px;
    }

    h1{
      margin:0;
      font-size:22px;
      letter-spacing:-0.02em;
    }

    .subtitle{
      font-size:13px;
      color:var(--muted);
      margin-top:4px;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(249,115,22,0.08);
      color:var(--accent-strong);
      margin-top:6px;
    }

    .tag-dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:var(--accent);
    }

    .card{
      background:var(--card);
      border-radius:var(--radius-lg);
      padding:20px 20px 18px;
      box-shadow:var(--shadow);
      border:1px solid rgba(248, 150, 75, 0.35);
    }

    .row{
      display:flex;
      gap:12px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }

    .col{
      flex:1;
      min-width:210px;
    }

    label{
      display:block;
      font-size:13px;
      color:#4b5563;
      margin-bottom:6px;
      font-weight:500;
    }

    .field-label-main{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .label-badge{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      background:#fffbeb;
      color:#b45309;
    }

    input[type=text],
    input[type=number],
    textarea,
    select{
      width:100%;
      padding:9px 11px;
      border:1px solid var(--border);
      border-radius:var(--radius-md);
      font-size:14px;
      background:#fefce8;
      transition:border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
    }

    input[type=text]:focus-visible,
    input[type=number]:focus-visible,
    textarea:focus-visible,
    select:focus-visible,
    button:focus-visible{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(249,115,22,0.5);
      background:#ffffff;
      transform:translateY(-1px);
    }

    textarea{
      min-height:120px;
      resize:vertical;
    }

    .muted{
      font-size:12px;
      color:var(--muted);
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      margin-top:16px;
    }

    button{
      background:var(--accent);
      color:#fff;
      border:none;
      padding:9px 16px;
      border-radius:999px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow:0 10px 18px rgba(194,65,12,0.45);
      transition:background var(--transition-fast), box-shadow var(--transition-fast), transform var(--transition-fast);
    }

    button:hover{
      background:var(--accent-strong);
      box-shadow:0 14px 26px rgba(180,83,9,0.55);
      transform:translateY(-1px);
    }

    button.secondary{
      background:#fffbeb;
      border:1px solid #fed7aa;
      color:#7c2d12;
      box-shadow:none;
    }

    button.secondary:hover{
      background:#fed7aa;
      box-shadow:0 6px 14px rgba(248, 150, 75, 0.45);
    }

    button.danger{
      background:var(--danger);
      box-shadow:0 10px 18px rgba(220,38,38,0.35);
    }
    button.danger:hover{
      background:#b91c1c;
      box-shadow:0 14px 26px rgba(185,28,28,0.45);
    }
    button.mini{
      padding:6px 10px;
      font-size:11px;
      box-shadow:none;
    }

    button[disabled]{
      opacity:0.6;
      cursor:default;
      box-shadow:none;
      transform:none;
    }

    .hidden{display:none}

    .note{
      font-size:13px;
      color:#111827;
      background:#fffbeb;
      padding:10px 11px;
      border-radius:var(--radius-md);
      border:1px solid #fed7aa;
    }

    .note-ghost{
      background:transparent;
      border-style:dashed;
      color:var(--muted);
    }

    .badge-status{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
    }

    .badge-status-dot{
      width:8px;
      height:8px;
      border-radius:999px;
    }

    .badge-status--ok{
      background:var(--ok-soft);
      color:var(--ok);
    }
    .badge-status--ok .badge-status-dot{background:var(--ok);}

    .badge-status--neg{
      background:var(--danger-soft);
      color:var(--danger);
    }
    .badge-status--neg .badge-status-dot{background:var(--danger);}

    .badge-status--info{
      background:var(--accent-soft);
      color:var(--accent-strong);
    }
    .badge-status--info .badge-status-dot{background:var(--accent);}

    .small{
      font-size:11px;
      color:var(--muted);
    }

    #ecartAffiche{
      margin-top:8px;
      font-weight:700;
      font-size:15px;
    }

    #result{
      margin-top:10px;
      min-height:20px;
    }

    #result .note{
      animation:fadeInUp 200ms ease-out;
    }

    @keyframes fadeInUp{
      from{opacity:0; transform:translateY(4px);}
      to{opacity:1; transform:translateY(0);}
    }

    .section-title{
      font-size:14px;
      font-weight:600;
      color:#111827;
      margin:10px 0 6px;
    }

    .section-caption{
      font-size:12px;
      color:var(--muted);
      margin-bottom:8px;
    }

    .logo{
      border-radius:12px;
      box-shadow:0 8px 18px rgba(249,115,22,0.7);
    }

    /* Grille de cases à cocher (process / disciplinaire) */
    .checkbox-grid{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .checkbox-grid label{
      display:flex;
      align-items:flex-start;
      gap:7px;
      padding:7px 10px;
      border-radius:var(--radius-md);
      border:1px solid #fed7aa;
      background:#fffbeb;
      font-size:12px;
      cursor:pointer;
    }
    .checkbox-grid input{
      margin-top:2px;
      accent-color:var(--accent);
    }

    /* === Caisses individuelles === */
    #caissesSection{
      margin-top:14px;
      border-radius:var(--radius-lg);
      background:linear-gradient(145deg, #111827 0, #020617 40%);
      color:#f9fafb;
      border:1px solid #1f2937;
    }

    #caissesSection .section-title{
      color:#fefce8;
    }

    #caissesSection .section-caption{
      color:#e5e7eb;
    }

    .caisse-card{
      margin-top:10px;
      border-radius:var(--radius-md);
      padding:10px 12px 12px;
      background:#fff7ed;
      color:#111827;
      border:1px solid #fed7aa;
    }

    .caisse-header-row{
      margin-bottom:6px;
      align-items:flex-end;
    }

    .caisse-remove-btn{
      padding:6px 10px;
      font-size:11px;
    }

    .caisse-table{
      margin-top:6px;
      border-radius:var(--radius-md);
      overflow:hidden;
      border:1px solid #fed7aa;
      background:#ffffff;
      font-size:12px;
    }

    .caisse-row,
    .caisse-table-header{
      display:grid;
      grid-template-columns:2fr 1fr 1fr;
      align-items:center;
    }

    .caisse-table-header{
      background:#f97316;
      color:#111827;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.04em;
      font-size:11px;
    }

    .caisse-cell{
      padding:6px 8px;
      border-bottom:1px solid #fed7aa;
      border-right:1px solid #fed7aa;
    }

    .caisse-row:last-child .caisse-cell{
      border-bottom:none;
    }

    .caisse-row .caisse-cell:last-child,
    .caisse-table-header .caisse-cell:last-child{
      border-right:none;
    }

    .caisse-row:nth-child(odd){
      background:#fff7ed;
    }

    .caisse-row-total{
      background:#fed7aa;
      font-weight:600;
    }

    .caisse-row-ecart{
      background:#22c55e;
      color:#022c22;
      font-weight:700;
    }

    .caisse-row-ecart .caisse-cell{
      border-bottom:none;
    }

    .caisse-row-ecart .caisse-cell:nth-child(2),
    .caisse-row-ecart .caisse-cell:nth-child(3){
      text-align:center;
    }

    .caisse-row input[type=number]{
      width:100%;
      padding:4px 6px;
      font-size:12px;
      border-radius:6px;
      background:#fefce8;
    }

    #caissesSummary{
      margin-top:8px;
      font-size:11px;
      color:#e5e7eb;
    }

    #addCaisseBtn{
      margin-top:8px;
      padding:6px 10px;
      font-size:12px;
      border-radius:999px;
      box-shadow:none;
    }

    /* ---- Heures supp (UI) ---- */
    .section-divider{height:1px;background:var(--border);margin:32px 0;}
    .inner-card{background:#fff;border:1px dashed var(--border);box-shadow:none;margin-top:14px;}
    .section-subtitle{font-weight:900;margin-bottom:8px;color:var(--accent-strong);}
    .radio-row{display:flex;gap:14px;flex-wrap:wrap;margin-top:6px;}
    .two-col{display:flex;gap:10px;flex-wrap:wrap;}
    .two-col > *{flex:1;min-width:180px;}
    .kpi{border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fff;}
    .kpi-value{font-size:22px;font-weight:900;}
    .kpi-note{font-size:12px;color:var(--muted);margin-top:6px;}
    .kpi-note.ok{color:var(--ok);font-weight:900;}
    .kpi-note.bad{color:var(--danger);font-weight:900;}
    .hs-emp-list{display:flex;flex-direction:column;gap:12px;margin-top:10px;}
    .hs-emp-item{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;}
    .hs-emp-head{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;}
    .hs-emp-title{font-weight:900;}
    .hs-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
    .hs-grid .full{grid-column:1 / -1;}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px;}
    .total-line{display:flex;gap:10px;justify-content:flex-end;align-items:center;}
    .danger-text{color:var(--danger);font-weight:900;}
    .ok-text{color:var(--ok);font-weight:900;}


    @media (max-width:640px){
      body{padding:18px 10px;}
      .card{padding:16px;}
      header{flex-direction:row;}
      .logo{width:38px;height:38px;}
      h1{font-size:19px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img
        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='44' height='44' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='6' fill='%23f97316'/%3E%3Ctext x='50%' y='55%' font-size='11' text-anchor='middle' fill='white' font-family='Arial' font-weight='700'%3EOT%3C/text%3E%3C/svg%3E"
        alt="logo"
        class="logo"
      />
      <div>
        <h1>Rapport Caisse & RH — Boulogne-sur-Mer</h1>
        <p class="subtitle">
          Formulaire pour signaler les écarts de caisse et déclarer les heures supplémentaires.
        </p>
      </div>
    </header>

    <form id="rapportForm" class="card" onsubmit="return false;" novalidate>
      <!-- === DÉMARRAGE : 2 QUESTIONS === -->
      <div class="row" style="margin-bottom:14px">
        <div class="col">
          <label>Questions (cocher)</label>
          <p class="small">Après sélection, le(s) formulaire(s) s’affichent pour être remplis.</p>

          <div class="checkbox-grid">
            <label>
              <input type="checkbox" id="qEcartCaisse" />
              <span>Écart caisse dans le service</span>
            </label>

            <label>
              <input type="checkbox" id="qHeuresSupp" />
              <span>Heures supp dans le service à déclarer</span>
            </label>
          </div>
        </div>
      </div>

      <!-- === SECTION CAISSE (masquée tant que la question n’est pas cochée) === -->
      <div id="caisseSectionGate" class="card inner-card hidden" style="margin-top:14px">
        <div class="section-title">Rapport écart de caisse</div>
        <p class="section-caption">À remplir uniquement si un écart de caisse est détecté.</p>

      <div class="row">
        <div class="col">
          <div class="field-label-main">
            <label for="montantTicketZ">Montant global Ticket&nbsp;Z (€)</label>
            <span class="label-badge">Source caisse</span>
          </div>
          <input id="montantTicketZ" type="number" step="0.01" min="0" autocomplete="off" required />
          <p class="small">Montant issu du ticket Z TTC de fin de service du responsable.</p>
        </div>
        <div class="col">
          <div class="field-label-main">
            <label for="montantReel">Montant global réel (€)</label>
            <span class="label-badge">Comptage physique</span>
          </div>
          <input id="montantReel" type="number" step="0.01" min="0" autocomplete="off" required />
          <p class="small">Montant compté réellement dans la caisse fin de service du responsable.</p>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="date">Date</label>
          <input id="date" type="text" placeholder="jj/mm/aaaa" autocomplete="off" />
          <p class="small">À remplir Par défaut&nbsp;: la date du jour de l'écart.</p>
        </div>
        <div class="col">
          <label for="auteur">Responsable de service</label>
          <input id="auteur" type="text" placeholder="Nom et prénom" required />
          <p class="small">Renseigner la personne qui valide le rapport.</p>
        </div>
      </div>

      <div class="row" style="align-items:flex-end">
        <div class="col">
          <label></label>
          <p class="muted"></p>
          <div id="ecartAffiche">Écart : —</div>
        </div>
        <div class="col">
          <label>Statut</label>
          <div id="statut" class="badge-status badge-status--info" aria-live="polite">
            <span class="badge-status-dot"></span>
            <span>En attente de saisie</span>
          </div>
        </div>
      </div>

      <!-- SECTION CAISSES -->
      <div id="caissesSection" class="card hidden">
        <div class="section-title">Répartition de l'écart par caisse / personne</div>
        <p class="section-caption">
          Ajoutez une caisse par personne impliquée dans l'écart (responsable, comptage et Ticket Z par mode de paiement).
        </p>

        <div id="caissesList"></div>

        <button type="button" class="secondary" id="addCaisseBtn">+ Ajouter une caisse</button>
        <p id="caissesSummary"></p>
      </div>

      <!-- PROCÉDURES SUIVIES -->
      <div style="margin-top:14px">
        <label>Procédures suivies (cocher si respectées)</label>
        <p class="small">Cochez chaque point qui a bien été respecté pour cet incident de caisse.</p>
        <div class="checkbox-grid">
          <label>
            <input type="checkbox" id="procShift" />
            <span>Comptage avec l’équipier après chaque shift</span>
          </label>
          <label>
            <input type="checkbox" id="procRespManager" />
            <span>Responsable encaisse dans la caisse manager + TPE Manager</span>
          </label>
          <label>
            <input type="checkbox" id="procEcartConstate" />
            <span>Écart fait constater à l’équipier</span>
          </label>
          <label>
            <input type="checkbox" id="procTelecollecte" />
            <span>Vérification rapport télécollecte avec le montant global TPE</span>
          </label>
        </div>
      </div>

      <div style="margin-top:14px">
        <label for="explication">Explication de l'incident et procédure suivie</label>
        <textarea
          id="explication"
          placeholder="Décrivez précisément l'incident, les vérifications effectuées et les actions prises..."
        ></textarea>
      </div>

      <!-- ZONE DISCIPLINAIRE -->
      <div style="margin-top:14px">
  <label>Zone disciplinaire</label>
  <p class="small">Indiquez le statut de la fiche incident liée au salarié.</p>
  <div class="checkbox-grid">
    <label>
      <input type="radio" name="discipline" value="a_faire" />
      <span>Fiche incident à faire au salarié (si pas encore faite, à faire juste après / jour même)</span>
    </label>
    <label>
      <input type="radio" name="discipline" value="faite" />
      <span>Fiche incident faite au salarié</span>
    </label>
  </div>

  <!-- ✅ Nouveau : explication qui s'affiche seulement si "a_faire" -->
  <div id="disciplineDetails" class="hidden" style="margin-top:10px">
    <label for="disciplineExplication">Explication / actions prévues</label>
    <textarea
      id="disciplineExplication"
      placeholder="Ex : Date prévue, salarié concerné, contexte, action corrective..."
    ></textarea>
  </div>
</div>
      </div>
      <!-- === FIN SECTION CAISSE === -->

      <!-- === SECTION HEURES SUPP (masquée tant que la question n’est pas cochée) === -->

      <!-- === SÉPARATEUR (uniquement si 2 sections affichées) === -->
      <div id="dualSectionDivider" class="section-divider hidden"></div>

      <!-- === SECTION HEURES SUPP (masquée tant que la question n’est pas cochée) === -->
      <div id="hsSectionGate" class="card hidden" style="margin-top:18px">
        <div class="section-title">Rapport Heures supplémentaires</div>
        <p class="section-caption">À remplir uniquement si des heures supp doivent être déclarées.</p>

        <div class="row">
          <div class="col">
            <label for="hsResponsable">Responsable qui valide</label>
            <input id="hsResponsable" type="text" placeholder="Nom du responsable" />
          </div>
          <div class="col">
            <label for="hsDate">Date</label>
            <input id="hsDate" type="text" placeholder="jj/mm/aaaa" />
            <p class="small">La date de l'écart.</p>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="hsCA">CA fin de journée (€)</label>
            <input id="hsCA" type="number" step="0.01" min="0" placeholder="Ex : 2500.00" />
          </div>
          <div class="col">
            <label for="hsHeuresSkello">Heures planifiées (Skello)</label>
            <input id="hsHeuresSkello" type="number" step="0.01" min="0" placeholder="Ex : 32.50" />
          </div>
        </div>

        <div class="card inner-card">
          <div class="section-subtitle">Organisation du service</div>

          <div class="row">
            <div class="col">
              <label>La production est bien gérée (pas de rupture en plein rush) ?</label>
              <div class="radio-row">
                <label><input type="radio" name="prodOk" value="oui" checked> Oui</label>
                <label><input type="radio" name="prodOk" value="non"> Non</label>
              </div>
              <div id="prodDetails" class="hidden" style="margin-top:8px">
                <textarea id="prodDesc" placeholder="Décrire la rupture / le problème de production..."></textarea>
              </div>
            </div>

            <div class="col">
              <label>Présence d’un salarié inefficace ?</label>
              <div class="radio-row">
                <label><input type="radio" name="ineffOk" value="non" checked> Non</label>
                <label><input type="radio" name="ineffOk" value="oui"> Oui</label>
              </div>
              <div id="ineffDetails" class="hidden" style="margin-top:8px">
                <div class="two-col">
                  <input id="ineffNom" type="text" placeholder="Quel salarié ?" />
                  <input id="ineffPoste" type="text" placeholder="Quel poste ?" />
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Panne matériel / problème inhabituel ?</label>
              <div class="radio-row">
                <label><input type="radio" name="panneOk" value="non" checked> Non</label>
                <label><input type="radio" name="panneOk" value="oui"> Oui</label>
              </div>
              <div id="panneDetails" class="hidden" style="margin-top:8px">
                <textarea id="panneDesc" placeholder="Décrire le problème..."></textarea>
              </div>
            </div>
          </div>
        </div>

        <div class="card inner-card">
          <div class="section-subtitle">Heures supplémentaires déclarées</div>
          <p class="small">Format obligatoire : <strong>xxHxxmin</strong> (ex : 18H05min)</p>

          <div id="hsEmployees" class="hs-emp-list"></div>

          <div class="row" style="align-items:center">
            <div class="col">
              <button type="button" class="btn secondary" id="hsAddEmployeeBtn">+ Ajouter un salarié</button>
            </div>
            <div class="col" style="text-align:right">
              <div class="total-line">
                <span>Total heures supp :</span>
                <strong id="hsTotalHeures">0,00h</strong>
              </div>
            </div>
          </div>
        </div>

        <div class="card inner-card" style="margin-top:14px">
          <div class="section-subtitle">Productivité</div>
          <div class="kpi">
            <div class="kpi-value" id="hsProductiviteValue">—</div>
            <div class="kpi-note" id="hsConclusion">Renseigne le CA, les heures Skello et les heures supp.</div>
          </div>
        </div>

      </div>




      <div class="actions">
        <button id="submitBtn" type="button">
          <span id="submitLabel">Enregistrer le rapport</span>
          <span id="submitSpinner" class="hidden">⏳</span>
        </button>
      </div>

      <div id="result" aria-live="polite"></div>
    </form>
  </div>

  <script>
    const APPS_SCRIPT_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwEnbCrzl4OKZ0wmh3klnHzQ8SwJwSP40AWctDOo8EzS2kv8dJZAPioGpp84b5VeVRG/exec';

    const euroFormatter = new Intl.NumberFormat('fr-FR', {
      style: 'currency',
      currency: 'EUR',
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });

    const formatEuro = (n) => euroFormatter.format(Number(n || 0));

    const montantTicketZEl = document.getElementById('montantTicketZ');
    const montantReelEl = document.getElementById('montantReel');
    const ecartAfficheEl = document.getElementById('ecartAffiche');
    const statutEl = document.getElementById('statut');
    const dateEl = document.getElementById('date');
    const auteurEl = document.getElementById('auteur');
    const resultEl = document.getElementById('result');
    const submitBtn = document.getElementById('submitBtn');
    const submitLabel = document.getElementById('submitLabel');
    const submitSpinner = document.getElementById('submitSpinner');

    // --- Zone disciplinaire (explication si "a_faire") ---
    const disciplineDetailsEl = document.getElementById('disciplineDetails');
    const disciplineExplicationEl = document.getElementById('disciplineExplication');

    function toggleDisciplineDetails(){
      const selected = document.querySelector('input[name="discipline"]:checked')?.value || '';
      const show = (selected === 'a_faire');
      if (disciplineDetailsEl) disciplineDetailsEl.classList.toggle('hidden', !show);
    }

    document.addEventListener('change', (e) => {
      if (e.target && e.target.name === 'discipline') {
        toggleDisciplineDetails();
      }
    });

    // Gates (2 questions) + sections
    const qEcartCaisseEl = document.getElementById('qEcartCaisse');
    const qHeuresSuppEl = document.getElementById('qHeuresSupp');
    const caisseSectionGateEl = document.getElementById('caisseSectionGate');
    const hsSectionGateEl = document.getElementById('hsSectionGate');

    // Champs Heures supp (nouvelle version)
    const dualSectionDividerEl = document.getElementById('dualSectionDivider');

    const hsResponsableEl = document.getElementById('hsResponsable');
    const hsDateEl = document.getElementById('hsDate');
    const hsCAEl = document.getElementById('hsCA');
    const hsHeuresSkelloEl = document.getElementById('hsHeuresSkello');

    const hsEmployeesEl = document.getElementById('hsEmployees');
    const hsAddEmployeeBtnEl = document.getElementById('hsAddEmployeeBtn');
    const hsTotalHeuresEl = document.getElementById('hsTotalHeures');

    const hsProductiviteValueEl = document.getElementById('hsProductiviteValue');
    const hsConclusionEl = document.getElementById('hsConclusion');

    const ineffDetailsEl = document.getElementById('ineffDetails');

    const prodDetailsEl = document.getElementById('prodDetails');
    const prodDescEl = document.getElementById('prodDesc');
    const ineffNomEl = document.getElementById('ineffNom');
    const ineffPosteEl = document.getElementById('ineffPoste');

    const panneDetailsEl = document.getElementById('panneDetails');
    const panneDescEl = document.getElementById('panneDesc');


    const caissesSectionEl = document.getElementById('caissesSection');
    const caissesListEl = document.getElementById('caissesList');
    const addCaisseBtn = document.getElementById('addCaisseBtn');
    const caissesSummaryEl = document.getElementById('caissesSummary');

    const MODES_PAIEMENT = ['Tickets Restaurant','Chèques vacances','Carte bancaire','Espèces'];

    (function initDate() {
      if (!dateEl.value) {
        dateEl.value = new Date().toLocaleDateString('fr-FR');
      }
    })();



    (function initDateHS(){
      if (hsDateEl && !hsDateEl.value) {
        hsDateEl.value = new Date().toLocaleDateString('fr-FR');
      }
    })()

    // ---------- Heures supp : logique ----------
    const TIME_RE = /^([01]?\d|2[0-3])\s*[Hh]\s*([0-5]\d)\s*(?:min)?$/;

    function parseTimeParts(v){
      const value = (v || '').trim();
      const m = TIME_RE.exec(value);
      if(!m) return null;
      const hh = parseInt(m[1], 10);
      const mm = parseInt(m[2], 10);
      return { hh, mm };
    }

    function parseTimeToMinutes(v){
      const parts = parseTimeParts(v);
      if(!parts) return null;
      return parts.hh * 60 + parts.mm;
    }

    function normalizeTimeString(v){
      const parts = parseTimeParts(v);
      if(!parts) return null;
      const hh = String(parts.hh).padStart(2,'0');
      const mm = String(parts.mm).padStart(2,'0');
      return `${hh}H${mm}min`;
    }

    function diffMinutes(startMin, endMin){
      if (startMin === null || endMin === null) return null;
      let d = endMin - startMin;
      if (d < 0) d += 24 * 60; // au cas où ça passe minuit
      return d;
    }

    function formatHoursFR(hours){
      const n = Number(hours || 0);
      const s = n.toFixed(2).replace('.', ',');
      return s + 'h';
    }

    function setConclusion(prod){
      hsConclusionEl.classList.remove('ok','bad');
      if (prod === null){
        hsConclusionEl.textContent = "Renseigne le CA, les heures Skello et les heures supp.";
        return;
      }
      if (prod >= 70){
        hsConclusionEl.classList.add('ok');
        hsConclusionEl.textContent = "✅ Productivité ≥ 70€ : les heures supp sont justifiées.";
      } else {
        hsConclusionEl.classList.add('bad');
        hsConclusionEl.textContent = "⛔ Productivité < 70€ : les heures supp ne sont pas justifiées.";
      }
    }

    function getRadioValue(name){
      const el = document.querySelector(`input[name="${name}"]:checked`);
      return el ? el.value : '';
    }

    function toggleDetailsByRadio(){
      const prod = getRadioValue('prodOk') === 'non';
      const ineff = getRadioValue('ineffOk') === 'oui';
      const panne = getRadioValue('panneOk') === 'oui';
      if (prodDetailsEl) prodDetailsEl.classList.toggle('hidden', !prod);
      if (ineffDetailsEl) ineffDetailsEl.classList.toggle('hidden', !ineff);
      if (panneDetailsEl) panneDetailsEl.classList.toggle('hidden', !panne);
    }

    document.addEventListener('change', (e) => {
      if (e.target && (e.target.name === 'prodOk' || e.target.name === 'ineffOk' || e.target.name === 'panneOk')) {
        toggleDetailsByRadio();

    // Recalcul de la productivité en direct
    if (hsCAEl) hsCAEl.addEventListener('input', recomputeHS);
    if (hsHeuresSkelloEl) hsHeuresSkelloEl.addEventListener('input', recomputeHS);

      }
    });
    toggleDetailsByRadio();

    // Recalcul de la productivité en direct
    if (hsCAEl) hsCAEl.addEventListener('input', recomputeHS);
    if (hsHeuresSkelloEl) hsHeuresSkelloEl.addEventListener('input', recomputeHS);


    let hsEmpCounter = 0;

    function employeeTemplate(id){
      const wrapper = document.createElement('div');
      wrapper.className = 'hs-emp-item';
      wrapper.dataset.empId = id;

      wrapper.innerHTML = `
        <div class="hs-emp-head">
          <div class="hs-emp-title">Salarié #${id}</div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button type="button" class="secondary mini" data-duplicate-emp="${id}">Dupliquer</button>
            <button type="button" class="danger mini" data-remove-emp="${id}">Supprimer</button>
          </div>
        </div>

        <div class="hs-grid">
          <div>
            <label>Poste occupé (salarié HS)</label>
            <input type="text" class="hs-poste" placeholder="Ex : Envoie / Pliage / Toaster / Caisse" />
          </div>

          <div>
            <label>Nom du salarié</label>
            <input type="text" class="hs-nom" placeholder="Nom et prénom" />
          </div>

          <div>
            <label>Heure début HS</label>
            <input type="text" class="hs-debut" placeholder="Ex : 18H05min" />
          </div>

          <div>
            <label>Heure fin HS</label>
            <input type="text" class="hs-fin" placeholder="Ex : 19H20min" />
          </div>

          <div>
            <label>Durée (total heure supp salarié)</label>
            <input type="text" class="hs-duree" placeholder="0,00h" readonly />
          </div>

          <div class="full">
            <label>Motif de rajout</label>
            <div class="radio-row">
              <label class="pill"><input type="radio" name="motif_${id}" value="1"> 1) Salarié absent (arrêt)</label>
              <label class="pill"><input type="radio" name="motif_${id}" value="2"> 2) Salarié absent (autre)</label>
              <label class="pill"><input type="radio" name="motif_${id}" value="3"> 3) Retard significatif</label>
              <label class="pill"><input type="radio" name="motif_${id}" value="4"> 4) Sous-effectif</label>
              <label class="pill"><input type="radio" name="motif_${id}" value="5"> 5) Rush fin de service</label>
            </div>

            <!-- Motif 1 / 2 : salarié absent -->
            <div class="hs-motif-abs hidden" style="margin-top:10px">
              <div class="two-col">
                <input type="text" class="hs-abs-nom" placeholder="Nom du salarié absent" />
                <input type="text" class="hs-abs-poste" placeholder="Poste du salarié absent" />
              </div>
              <div class="two-col" style="margin-top:10px">
                <div>
                  <label>Shift prévu du salarié absent (début de service)</label>
                  <input type="text" class="hs-prevu-debut" placeholder="Ex : 18H00min" />
                </div>
                <div>
                  <label>Shift prévu du salarié absent (fin de service)</label>
                  <input type="text" class="hs-prevu-fin" placeholder="Ex : 22H00min" />
                </div>
              </div>
            </div>

            <!-- Motif 3 : retard -->
            <div class="hs-motif-retard hidden" style="margin-top:10px">
              <div class="two-col">
                <input type="text" class="hs-retard-nom" placeholder="Quel salarié est en retard ?" />
                <input type="number" class="hs-retard-min" min="1" step="1" placeholder="Retard (min)" />
              </div>
              <div style="margin-top:10px">
                <input type="text" class="hs-retard-moment" placeholder="Quel moment dans le service ? (ex : début / milieu / fin, poste concerné…)" />
              </div>
            </div>

            <!-- Motif 4 / 5 : détail -->
            <div class="hs-motif-detail hidden" style="margin-top:10px">
              <label class="hs-detail-label">Détails</label>
              <textarea class="hs-detail" placeholder="Décrire précisément..."></textarea>
            </div>

            <div style="margin-top:10px">
              <label>Commentaire (Plus d'information concernant le service)</label>
              <textarea class="hs-comment" placeholder="Détails complémentaires..."></textarea>
            </div>
          </div>
        </div>
      `;

      // init motif blocks (none selected yet)
      updateMotifBlocks(wrapper, '');

      // listeners
      wrapper.addEventListener('input', (e) => {
        if (e.target.classList.contains('hs-debut') || e.target.classList.contains('hs-fin')) {
          computeEmployeeDuration(wrapper);
          recomputeHS();
        }
      });

      wrapper.addEventListener('change', (e) => {
        if (e.target && e.target.name === `motif_${id}`){
          updateMotifBlocks(wrapper, e.target.value);
        }
        recomputeHS();
      });

      // Normalise les heures (format canonique : XXHXXmin) à la sortie du champ
      wrapper.addEventListener('focusout', (e) => {
        const t = e.target;
        if (!t || !t.classList) return;
        const isTimeField =
          t.classList.contains('hs-debut') ||
          t.classList.contains('hs-fin') ||
          t.classList.contains('hs-prevu-debut') ||
          t.classList.contains('hs-prevu-fin');
        if (!isTimeField) return;

        const norm = normalizeTimeString(t.value);
        if (norm) t.value = norm;

        // recalcul si besoin (utile après normalisation)
        if (t.classList.contains('hs-debut') || t.classList.contains('hs-fin')) {
          computeEmployeeDuration(wrapper);
        }
        recomputeHS();
      });

      return wrapper;
    }


    function updateMotifBlocks(wrapper, motifCode){
      const absWrap = wrapper.querySelector('.hs-motif-abs');
      const retWrap = wrapper.querySelector('.hs-motif-retard');
      const detWrap = wrapper.querySelector('.hs-motif-detail');
      const detLabel = wrapper.querySelector('.hs-detail-label');

      const isAbs = (motifCode === '1' || motifCode === '2');
      const isRet = (motifCode === '3');
      const isDet = (motifCode === '4' || motifCode === '5');

      if (absWrap) absWrap.classList.toggle('hidden', !isAbs);
      if (retWrap) retWrap.classList.toggle('hidden', !isRet);
      if (detWrap) detWrap.classList.toggle('hidden', !isDet);

      if (detLabel){
        if (motifCode === '4') detLabel.textContent = "Sous-effectif : détails";
        else if (motifCode === '5') detLabel.textContent = "Rush fin de service : détails";
        else detLabel.textContent = "Détails";
      }
    }

    function extractEmployeeValues(wrapper){
      const empId = wrapper.dataset.empId || '';
      const motif = (wrapper.querySelector(`input[name="motif_${empId}"]:checked`)?.value || '').trim();
      return {
        poste: (wrapper.querySelector('.hs-poste')?.value || '').trim(),
        nom: (wrapper.querySelector('.hs-nom')?.value || '').trim(),
        debut: (wrapper.querySelector('.hs-debut')?.value || '').trim(),
        fin: (wrapper.querySelector('.hs-fin')?.value || '').trim(),
        motif,
        abs_nom: (wrapper.querySelector('.hs-abs-nom')?.value || '').trim(),
        abs_poste: (wrapper.querySelector('.hs-abs-poste')?.value || '').trim(),
        prevu_debut: (wrapper.querySelector('.hs-prevu-debut')?.value || '').trim(),
        prevu_fin: (wrapper.querySelector('.hs-prevu-fin')?.value || '').trim(),
        retard_nom: (wrapper.querySelector('.hs-retard-nom')?.value || '').trim(),
        retard_min: (wrapper.querySelector('.hs-retard-min')?.value || '').trim(),
        retard_moment: (wrapper.querySelector('.hs-retard-moment')?.value || '').trim(),
        detail: (wrapper.querySelector('.hs-detail')?.value || '').trim(),
        comment: (wrapper.querySelector('.hs-comment')?.value || '').trim(),
      };
    }

    function applyEmployeeValues(wrapper, values){
      if (!values) return;

      wrapper.querySelector('.hs-poste').value = values.poste || '';
      wrapper.querySelector('.hs-nom').value = values.nom || '';
      wrapper.querySelector('.hs-debut').value = values.debut || '';
      wrapper.querySelector('.hs-fin').value = values.fin || '';

      const empId = wrapper.dataset.empId || '';
      if (values.motif){
        const m = wrapper.querySelector(`input[name="motif_${empId}"][value="${values.motif}"]`);
        if (m) m.checked = true;
      }
      updateMotifBlocks(wrapper, values.motif || '');

      const setVal = (sel, v) => { const el = wrapper.querySelector(sel); if (el) el.value = v || ''; };
      setVal('.hs-abs-nom', values.abs_nom);
      setVal('.hs-abs-poste', values.abs_poste);
      setVal('.hs-prevu-debut', values.prevu_debut);
      setVal('.hs-prevu-fin', values.prevu_fin);
      setVal('.hs-retard-nom', values.retard_nom);
      setVal('.hs-retard-min', values.retard_min);
      setVal('.hs-retard-moment', values.retard_moment);
      setVal('.hs-detail', values.detail);
      setVal('.hs-comment', values.comment);

      computeEmployeeDuration(wrapper);
    }


    function addEmployee(){
      hsEmpCounter += 1;
      const item = employeeTemplate(hsEmpCounter);
      hsEmployeesEl.appendChild(item);
      recomputeHS();
    }

    function removeEmployee(empId){
      const el = hsEmployeesEl.querySelector(`[data-emp-id="${empId}"]`);
      if (el) el.remove();
      recomputeHS();
    }

    function duplicateEmployee(empId){
      const src = hsEmployeesEl.querySelector(`[data-emp-id="${empId}"]`);
      if (!src) return;
      const values = extractEmployeeValues(src);

      hsEmpCounter += 1;
      const item = employeeTemplate(hsEmpCounter);
      hsEmployeesEl.appendChild(item);
      applyEmployeeValues(item, values);
      recomputeHS();
    }

    function computeEmployeeDuration(wrapper){
      const debut = wrapper.querySelector('.hs-debut')?.value || '';
      const fin = wrapper.querySelector('.hs-fin')?.value || '';
      const dMin = parseTimeToMinutes(debut);
      const fMin = parseTimeToMinutes(fin);
      const diff = diffMinutes(dMin, fMin);
      const dureeEl = wrapper.querySelector('.hs-duree');

      if (diff === null){
        if (dureeEl) dureeEl.value = '';
        return null;
      }
      const hours = diff / 60;
      if (dureeEl) dureeEl.value = formatHoursFR(hours);
      return hours;
    }

    function getTotalHS(){
      let total = 0;
      const items = hsEmployeesEl ? Array.from(hsEmployeesEl.querySelectorAll('.hs-emp-item')) : [];
      for (const it of items){
        const h = computeEmployeeDuration(it);
        if (typeof h === 'number' && isFinite(h)) total += h;
      }
      return total;
    }

    function recomputeHS(){
      if (!hsSectionGateEl) return;

      const totalHS = getTotalHS();
      if (hsTotalHeuresEl) hsTotalHeuresEl.textContent = formatHoursFR(totalHS);

      const ca = parseFloat(hsCAEl?.value || '');
      const skello = parseFloat(hsHeuresSkelloEl?.value || '');
      const denom = (isFinite(skello) ? skello : 0) + totalHS;

      let prod = null;
      if (isFinite(ca) && ca > 0 && denom > 0){
        prod = (ca / 1.1) / denom;
        hsProductiviteValueEl.textContent = prod.toFixed(2).replace('.', ',') + ' € / h';
      } else {
        hsProductiviteValueEl.textContent = '—';
      }
      setConclusion(prod);
    }

    if (hsAddEmployeeBtnEl) {
      hsAddEmployeeBtnEl.addEventListener('click', addEmployee);
    }

    document.addEventListener('click', (e) => {
      const removeBtn = e.target?.closest?.('[data-remove-emp]');
      if (removeBtn){
        const id = removeBtn.getAttribute('data-remove-emp');
        removeEmployee(id);
        return;
      }
      const dupBtn = e.target?.closest?.('[data-duplicate-emp]');
      if (dupBtn){
        const id = dupBtn.getAttribute('data-duplicate-emp');
        duplicateEmployee(id);
        return;
      }
    });
;

    function updateGates(){
      const showCaisse = !!(qEcartCaisseEl && qEcartCaisseEl.checked);
      const showHS = !!(qHeuresSuppEl && qHeuresSuppEl.checked);

      if (caisseSectionGateEl) caisseSectionGateEl.classList.toggle('hidden', !showCaisse);
      if (hsSectionGateEl) hsSectionGateEl.classList.toggle('hidden', !showHS);

      // Séparateur si les 2 rapports sont cochés
      if (dualSectionDividerEl) {
        dualSectionDividerEl.classList.toggle('hidden', !(showCaisse && showHS));
      }

      // Si HS vient d’être affiché, on initialise au moins 1 salarié
      if (showHS && hsEmployeesEl && hsEmployeesEl.children.length === 0) {
        addEmployee();
      }

      // Recalcule KPI
      if (showHS) recomputeHS();
    }

    if (qEcartCaisseEl) qEcartCaisseEl.addEventListener('change', updateGates);
    if (qHeuresSuppEl) qHeuresSuppEl.addEventListener('change', updateGates);

    // au chargement
    updateGates();
    toggleDisciplineDetails();

function setStatus({ type = 'info', message }) {
      statutEl.className = 'badge-status badge-status--' + type;
      statutEl.innerHTML = `
        <span class="badge-status-dot"></span>
        <span>${message}</span>
      `;
    }

    function getGlobalEcart() {
      const z = parseFloat(montantTicketZEl.value || 0);
      const r = parseFloat(montantReelEl.value || 0);
      return r - z;
    }

    function updateEcart() {
      const hasZ = montantTicketZEl.value !== '';
      const hasR = montantReelEl.value !== '';

      // Si une des deux cases n'est pas remplie : pas d'écart affiché
      if (!hasZ || !hasR) {
        ecartAfficheEl.textContent = 'Écart : —';
        setStatus({ type: 'info', message: 'En attente de saisie des deux montants' });
        caissesSectionEl.classList.add('hidden');
        return;
      }

      const diff = getGlobalEcart();
      ecartAfficheEl.textContent = 'Écart : ' + formatEuro(diff);

      if (Math.abs(diff) < 0.005) {
        setStatus({ type: 'ok', message: 'OK — aucun écart détecté' });
        caissesSectionEl.classList.add('hidden');
      } else {
        const label = diff > 0 ? 'Écart POSITIF (surplus caisse)' : 'Écart NÉGATIF (manque en caisse)';
        setStatus({ type: 'neg', message: label });
        caissesSectionEl.classList.remove('hidden');
        if (caissesListEl.children.length === 0) {
          addCaisse();
        }
      }

      updateCaissesSummary();
    }

    montantTicketZEl.addEventListener('input', updateEcart);
    montantReelEl.addEventListener('input', updateEcart);

    function addCaisse() {
      const index = caissesListEl.children.length + 1;
      const wrapper = document.createElement('div');
      wrapper.className = 'caisse-card';
      wrapper.dataset.index = index;

      wrapper.innerHTML = `
        <div class="row caisse-header-row">
          <div class="col">
            <label>Équipier/Responsable</label>
            <input type="text" class="caisse-responsable" placeholder="Nom" />
          </div>
          <div class="col">
            <label>Horaires</label>
            <input type="text" class="caisse-horaires" placeholder="Ex : 11h30–14h30" />
          </div>
          <div class="col" style="max-width:140px;text-align:right;">
            <button type="button" class="secondary caisse-remove-btn">Supprimer</button>
          </div>
        </div>

        <div class="caisse-table">
          <div class="caisse-table-header">
            <div class="caisse-cell">Mode de paiement</div>
            <div class="caisse-cell">Comptage</div>
            <div class="caisse-cell">Ticket Z</div>
          </div>
          ${MODES_PAIEMENT.map(mode => `
          <div class="caisse-row">
            <div class="caisse-cell"><strong>${mode.toUpperCase()}</strong></div>
            <div class="caisse-cell">
              <input type="number" step="0.01" class="caisse-comptage" data-mode="${mode}" />
            </div>
            <div class="caisse-cell">
              <input type="number" step="0.01" class="caisse-z" data-mode="${mode}" />
            </div>
          </div>
          `).join('')}
          <div class="caisse-row caisse-row-total">
            <div class="caisse-cell"><strong>Résultat caisse</strong></div>
            <div class="caisse-cell"><span class="caisse-total-comptage">0,00&nbsp;€</span></div>
            <div class="caisse-cell"><span class="caisse-total-z">0,00&nbsp;€</span></div>
          </div>
          <div class="caisse-row caisse-row-ecart">
            <div class="caisse-cell"><strong>Écart</strong></div>
            <div class="caisse-cell" style="grid-column:2 / 4; text-align:center;">
              <span class="caisse-ecart">0,00&nbsp;€</span>
            </div>
          </div>
        </div>
      `;

      wrapper.querySelectorAll('.caisse-comptage, .caisse-z').forEach(input => {
        input.addEventListener('input', () => updateCaisseTotals(wrapper));
      });

      wrapper.querySelector('.caisse-remove-btn').addEventListener('click', () => {
        wrapper.remove();
        updateCaissesSummary();
      });

      caissesListEl.appendChild(wrapper);
    }

    function updateCaisseTotals(card) {
      let totalC = 0;
      let totalZ = 0;

      card.querySelectorAll('.caisse-comptage').forEach(input => {
        totalC += parseFloat(input.value || 0);
      });
      card.querySelectorAll('.caisse-z').forEach(input => {
        totalZ += parseFloat(input.value || 0);
      });

      const ecart = totalC - totalZ;

      card.querySelector('.caisse-total-comptage').textContent = formatEuro(totalC);
      card.querySelector('.caisse-total-z').textContent = formatEuro(totalZ);
      card.querySelector('.caisse-ecart').textContent = formatEuro(ecart);

      card.dataset.totalComptage = totalC.toFixed(2);
      card.dataset.totalTicketZ = totalZ.toFixed(2);
      card.dataset.ecart = ecart.toFixed(2);

      updateCaissesSummary();
    }

    function updateCaissesSummary() {
      const cards = Array.from(document.querySelectorAll('.caisse-card'));
      if (cards.length === 0) {
        caissesSummaryEl.textContent = '';
        return;
      }

      let sommeEcarts = 0;
      cards.forEach(c => {
        sommeEcarts += parseFloat(c.dataset.ecart || 0);
      });

      const global = getGlobalEcart();
      const diff = sommeEcarts - global;

      let message = `Somme des écarts par caisse : ${formatEuro(sommeEcarts)} — Écart global : ${formatEuro(global)} `;
      if (Math.abs(diff) > 0.01) {
        message += ` (⚠ différence de ${formatEuro(diff)})`;
      } else {
        message += ' (OK)';
      }
      caissesSummaryEl.textContent = message;
    }

    addCaisseBtn.addEventListener('click', () => {
      addCaisse();
      updateCaissesSummary();
    });

    function collectCaisses() {
      const cards = Array.from(document.querySelectorAll('.caisse-card'));
      return cards.map(card => {
        const responsable = card.querySelector('.caisse-responsable').value.trim();
        const horaires = card.querySelector('.caisse-horaires').value.trim();

        const lignes = MODES_PAIEMENT.map(mode => {
          const comptageEl = card.querySelector(`.caisse-comptage[data-mode="${mode}"]`);
          const zEl = card.querySelector(`.caisse-z[data-mode="${mode}"]`);
          const comptage = parseFloat(comptageEl?.value || 0);
          const ticketZ = parseFloat(zEl?.value || 0);
          return {
            mode,
            comptage: comptage.toFixed(2),
            ticketZ: ticketZ.toFixed(2)
          };
        });

        let totalComptage = 0;
        let totalTicketZ = 0;
        lignes.forEach(l => {
          totalComptage += parseFloat(l.comptage);
          totalTicketZ += parseFloat(l.ticketZ);
        });
        const ecart = totalComptage - totalTicketZ;

        return {
          responsable,
          horaires,
          lignes,
          totalComptage: totalComptage.toFixed(2),
          totalTicketZ: totalTicketZ.toFixed(2),
          ecart: ecart.toFixed(2)
        };
      });
    }


    function collectHeuresSupp(){
      const isHS = !!(qHeuresSuppEl && qHeuresSuppEl.checked);
      if (!isHS) {
        return { active:false };
      }

      const employees = [];
      const items = hsEmployeesEl ? Array.from(hsEmployeesEl.querySelectorAll('.hs-emp-item')) : [];
      for (const it of items){
        const empId = it.dataset.empId || '';
        const poste = (it.querySelector('.hs-poste')?.value || '').trim();
        const nom = (it.querySelector('.hs-nom')?.value || '').trim();
        const debut = (it.querySelector('.hs-debut')?.value || '').trim();
        const fin = (it.querySelector('.hs-fin')?.value || '').trim();

        const mEl = it.querySelector(`input[name="motif_${empId}"]:checked`);
        const motifCode = mEl ? mEl.value : '';

        const abs_nom = (it.querySelector('.hs-abs-nom')?.value || '').trim();
        const abs_poste = (it.querySelector('.hs-abs-poste')?.value || '').trim();
        const prevu_debut = (it.querySelector('.hs-prevu-debut')?.value || '').trim();
        const prevu_fin = (it.querySelector('.hs-prevu-fin')?.value || '').trim();

        const retard_nom = (it.querySelector('.hs-retard-nom')?.value || '').trim();
        const retard_min = (it.querySelector('.hs-retard-min')?.value || '').trim();
        const retard_moment = (it.querySelector('.hs-retard-moment')?.value || '').trim();

        const detail = (it.querySelector('.hs-detail')?.value || '').trim();
        const comment = (it.querySelector('.hs-comment')?.value || '').trim();

        const hours = computeEmployeeDuration(it);
        employees.push({
          poste,
          nom,
          debut,
          fin,
          nb_heures: (typeof hours === 'number' && isFinite(hours)) ? hours.toFixed(2) : '',
          motif_code: motifCode,

          absent_salarie_nom: (motifCode === '1' || motifCode === '2') ? abs_nom : '',
          absent_salarie_poste: (motifCode === '1' || motifCode === '2') ? abs_poste : '',
          shift_prevu_debut: (motifCode === '1' || motifCode === '2') ? prevu_debut : '',
          shift_prevu_fin: (motifCode === '1' || motifCode === '2') ? prevu_fin : '',

          retard_salarie_nom: (motifCode === '3') ? retard_nom : '',
          retard_duree_min: (motifCode === '3') ? retard_min : '',
          retard_moment: (motifCode === '3') ? retard_moment : '',

          detail: (motifCode === '4' || motifCode === '5') ? detail : '',
          commentaire: comment
        });
      }

      const totalHS = getTotalHS();
      const ca = parseFloat(hsCAEl?.value || '');
      const skello = parseFloat(hsHeuresSkelloEl?.value || '');
      const denom = (isFinite(skello) ? skello : 0) + totalHS;

      let productivite = '';
      if (isFinite(ca) && ca > 0 && denom > 0){
        productivite = ((ca / 1.1) / denom).toFixed(2);
      }

      return {
        active: true,
        responsable_validation: (hsResponsableEl?.value || '').trim(),
        date: (hsDateEl?.value || '').trim(),
        ca_journee: isFinite(ca) ? ca.toFixed(2) : '',
        heures_skello: isFinite(skello) ? skello.toFixed(2) : '',
        total_heures_supp: totalHS.toFixed(2),
        productivite: productivite, // €/h (formule cachée)
        conclusion: productivite ? (parseFloat(productivite) >= 70 ? 'justifiee' : 'non_justifiee') : '',
        organisation: {
          production_ok: getRadioValue('prodOk'),
          production_description: (getRadioValue('prodOk') === 'non') ? (prodDescEl?.value || '').trim() : '',
          inefficace: getRadioValue('ineffOk'),
          inefficace_nom: (ineffNomEl?.value || '').trim(),
          inefficace_poste: (ineffPosteEl?.value || '').trim(),
          panne: getRadioValue('panneOk'),
          panne_description: (panneDescEl?.value || '').trim()
        },
        employees
      };
    }


    function collectForm() {
      const dateValue = dateEl.value || new Date().toLocaleDateString('fr-FR');
      const ecartVal = getGlobalEcart();
      const montantEcartVal = Math.abs(ecartVal);

      const disciplineInput = document.querySelector('input[name="discipline"]:checked');
      const discipline = disciplineInput ? disciplineInput.value : '';

      return {
        titre: 'Rapport Caisse Boulogne sur mer',
        date: dateValue,
        auteur: auteurEl.value.trim(),
        montantTicketZ: parseFloat(montantTicketZEl.value || 0).toFixed(2),
        montantReel: parseFloat(montantReelEl.value || 0).toFixed(2),
        ecart: ecartVal.toFixed(2),
        responsable: '',
        montantEcart: montantEcartVal.toFixed(2),
        natures: [],
        naturePrecise: '',
        procedures: {
          comptage_shift: document.getElementById('procShift').checked,
          resp_manager: document.getElementById('procRespManager').checked,
          ecart_constate: document.getElementById('procEcartConstate').checked,
          telecollecte: document.getElementById('procTelecollecte').checked
        },
        discipline: discipline,
        discipline_explication: (discipline === 'a_faire')
          ? (document.getElementById('disciplineExplication')?.value || '')
          : '',
        explication: document.getElementById('explication').value,

        questions: {
          ecart_caisse: !!(qEcartCaisseEl && qEcartCaisseEl.checked),
          heures_supp: !!(qHeuresSuppEl && qHeuresSuppEl.checked)
        },

        hs: collectHeuresSupp(),

        caisses: collectCaisses()};
    }

    function validateForm() {
      let valid = true;
      const errors = [];

      const isCaisse = !!(qEcartCaisseEl && qEcartCaisseEl.checked);
      const isHS = !!(qHeuresSuppEl && qHeuresSuppEl.checked);

      if (!isCaisse && !isHS) {
        valid = false;
        errors.push("Coche au moins une option : Écart caisse ou Heures supp.");
      }

      // Valider uniquement la partie CAISSE si elle est demandée
      if (isCaisse) {
        if (!montantTicketZEl.value) {
          valid = false;
          errors.push('Le montant du Ticket Z est obligatoire.');
        }
        if (!montantReelEl.value) {
          valid = false;
          errors.push('Le montant réel de la caisse est obligatoire.');
        }
        if (!auteurEl.value.trim()) {
          valid = false;
          errors.push("Le nom du responsable de service est obligatoire.");
        }

        // Zone disciplinaire : si "a_faire", explication obligatoire
        const disciplineVal = document.querySelector('input[name="discipline"]:checked')?.value || '';
        if (disciplineVal === 'a_faire') {
          const txt = document.getElementById('disciplineExplication')?.value?.trim() || '';
          if (!txt) {
            valid = false;
            errors.push("Zone disciplinaire : ajoute une explication (si la fiche incident est à faire).");
          }
        }
      }

      // Valider uniquement la partie HEURES SUPP si elle est demandée
      if (isHS) {
        if (!hsResponsableEl.value.trim()) {
          valid = false;
          errors.push("Heures supp : le responsable qui valide est obligatoire.");
        }
        if (!hsDateEl.value.trim()) {
          valid = false;
          errors.push("Heures supp : la date est obligatoire.");
        }
        if (!hsCAEl.value) {
          valid = false;
          errors.push("Heures supp : le CA fin de journée est obligatoire.");
        }
        if (!hsHeuresSkelloEl.value) {
          valid = false;
          errors.push("Heures supp : les heures Skello sont obligatoires.");
        }

        // Organisation
        if (getRadioValue('prodOk') === 'non') {
          if (!prodDescEl?.value?.trim()) {
            valid = false;
            errors.push("Organisation : décris le problème de production (si 'Non').");
          }
        }
        if (getRadioValue('ineffOk') === 'oui') {
          if (!ineffNomEl.value.trim() || !ineffPosteEl.value.trim()) {
            valid = false;
            errors.push("Organisation : indique le salarié inefficace et son poste.");
          }
        }
        if (getRadioValue('panneOk') === 'oui') {
          if (!panneDescEl.value.trim()) {
            valid = false;
            errors.push("Organisation : décris la panne/problème inhabituel.");
          }
        }

        // Salariés HS
        const items = hsEmployeesEl ? Array.from(hsEmployeesEl.querySelectorAll('.hs-emp-item')) : [];
        if (items.length === 0) {
          valid = false;
          errors.push("Heures supp : ajoute au moins un salarié.");
        }

        items.forEach((it, idx) => {
          const num = idx + 1;
          const poste = (it.querySelector('.hs-poste')?.value || '').trim();
          const nom = (it.querySelector('.hs-nom')?.value || '').trim();
          const debut = (it.querySelector('.hs-debut')?.value || '').trim();
          const fin = (it.querySelector('.hs-fin')?.value || '').trim();

          const empId = it.dataset.empId || '';
          const mEl = it.querySelector(`input[name="motif_${empId}"]:checked`);
          const motif = mEl ? mEl.value : '';

          if (!poste) { valid = false; errors.push(`Heures supp (salarié #${num}) : le poste est obligatoire.`); }
          if (!nom) { valid = false; errors.push(`Heures supp (salarié #${num}) : le nom est obligatoire.`); }

          if (!debut || !TIME_RE.test(debut)) {
            valid = false;
            errors.push(`Heures supp (salarié #${num}) : heure début invalide (format xxHxxmin).`);
          }
          if (!fin || !TIME_RE.test(fin)) {
            valid = false;
            errors.push(`Heures supp (salarié #${num}) : heure fin invalide (format xxHxxmin).`);
          }

          const hours = computeEmployeeDuration(it);
          if (!(typeof hours === 'number' && isFinite(hours) && hours >= 0)) {
            valid = false;
            errors.push(`Heures supp (salarié #${num}) : durée impossible à calculer.`);
          }

          if (!motif) {
            valid = false;
            errors.push(`Heures supp (salarié #${num}) : sélectionne un motif.`);
          }

          if (motif === '1' || motif === '2') {
            const absNom = (it.querySelector('.hs-abs-nom')?.value || '').trim();
            const prevuDebut = (it.querySelector('.hs-prevu-debut')?.value || '').trim();
            const prevuFin = (it.querySelector('.hs-prevu-fin')?.value || '').trim();

            if (!absNom) {
              valid = false;
              errors.push(`Heures supp (salarié #${num}) : nom du salarié absent obligatoire.`);
            }
            if (!prevuDebut || !TIME_RE.test(prevuDebut) || !prevuFin || !TIME_RE.test(prevuFin)) {
              valid = false;
              errors.push(`Heures supp (salarié #${num}) : shift prévu obligatoire (format xxHxxmin).`);
            }
          }

          if (motif === '3') {
            const rNom = (it.querySelector('.hs-retard-nom')?.value || '').trim();
            const rMin = (it.querySelector('.hs-retard-min')?.value || '').trim();
            const rMoment = (it.querySelector('.hs-retard-moment')?.value || '').trim();

            const minVal = parseInt(rMin, 10);
            if (!rNom) {
              valid = false;
              errors.push(`Heures supp (salarié #${num}) : indique quel salarié est en retard.`);
            }
            if (!rMin || !isFinite(minVal) || minVal <= 0) {
              valid = false;
              errors.push(`Heures supp (salarié #${num}) : indique le retard en minutes (> 0).`);
            }
            if (!rMoment) {
              valid = false;
              errors.push(`Heures supp (salarié #${num}) : indique à quel moment dans le service le retard a impacté.`);
            }
          }

          if (motif === '4' || motif === '5') {
            const detail = (it.querySelector('.hs-detail')?.value || '').trim();
            if (!detail) {
              valid = false;
              errors.push(`Heures supp (salarié #${num}) : détail obligatoire pour ce motif.`);
            }
          }
        });

        // Mettre à jour la productivité
        recomputeHS();
      }


      if (!valid) {
        resultEl.innerHTML = `
          <div class="note note-ghost">
            ${errors.map((e) => '• ' + e).join('<br>')}
          </div>
        `;
      } else {
        resultEl.innerHTML = '';
      }

      return valid;
    }
function setLoading(isLoading) {
      submitBtn.disabled = isLoading;
      submitSpinner.classList.toggle('hidden', !isLoading);
      submitLabel.textContent = isLoading ? 'Enregistrement en cours...' : 'Enregistrer le rapport';
    }
submitBtn.addEventListener('click', () => {
  if (!validateForm()) return;

  setLoading(true);
  setStatus({ type: 'info', message: 'Enregistrement du rapport en cours...' });

  const data = collectForm();

  google.script.run
    .withSuccessHandler((j) => {
      if (j && j.success) {
        setStatus({ type: 'ok', message: 'Rapport enregistré avec succès' });
        resultEl.innerHTML = `
          <div class="note">
            Rapport enregistré&nbsp;:
            <a href="${j.fileUrl}" target="_blank" rel="noopener noreferrer">
              Ouvrir le PDF dans Google Drive
            </a>
          </div>
        `;
      } else {
        setStatus({ type: 'neg', message: "Erreur lors de l'enregistrement" });
        resultEl.innerHTML = `
          <div class="note note-ghost">
            Erreur&nbsp;: ${j?.error || "Échec de l'enregistrement du rapport."}
          </div>
        `;
      }
      setLoading(false);
    })
    .withFailureHandler((err) => {
      setStatus({ type: 'neg', message: 'Erreur serveur' });
      resultEl.innerHTML = `
        <div class="note note-ghost">
          Erreur serveur&nbsp;: ${err?.message || err}
        </div>
      `;
      setLoading(false);
    })
    .createReport(data);
});
   
  </script>

  <!-- Côté Apps Script, tu recevras maintenant:
       - data.procedures.{comptage_shift, resp_manager, ecart_constate, telecollecte}
       - data.discipline ("a_faire" ou "faite")
       à exploiter dans le PDF si tu veux. -->
</body>
</html>
